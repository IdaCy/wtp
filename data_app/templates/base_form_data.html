{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ page_title }} - Wildlife Transfer Parameter DB{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/base_form_data.css' %}">

    <!-- libraries for the JQuery for making article_title a search bar -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!-- getting magnifying glass for heuristic -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}

{% block content %}
    <h1>{{ heading }}</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert {{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!--<form method="post" action="{ block form_action_url %}{ endblock form_action_url %}">-->
    <form method="post" action="{% block form_action %}{% endblock form_action %}">
        <!--<form method="post" action="{#  #}{ form_action }}">-->
        {% csrf_token %}

        <!-- Display form errors here -->
        {% if datacr_form.errors %}
            <div class="alert alert-danger" role="alert">
                Please correct the errors below.
            </div>
        {% endif %}

        <!-- Display field-specific error messages -->
        {% if datacr_form.habitat.errors %}
            <div class="alert alert-warning" role="alert">
                {{ datacr_form.habitat.errors.as_text }}
            </div>
        {% endif %}

        {% if reference_form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in reference_form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        {% if datacr_form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in datacr_form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}


        {% block javascript %}
            {# needs to stay here: Django template tags are not processed in static files #}
            {# These template tags are only interpreted by Django when they're found in .html template files! #}
            <script>
                $(document).ready(function () {
                    $("#id_article_title").autocomplete({
                        source: "{% url 'article-search' %}",
                        minLength: 2, // Minimum length before searching
                        select: function (event, ui) {
                            $('#id_article_title').val(ui.item.value); // Set the value for the article title input
                        }
                    });
                });
                $(document).ready(function () {
                    // Change the background image based on input
                    $('#id_article_title').on('input', function () {
                        if ($(this).val().length > 0) {
                            $(this).css('background-image', 'none');
                        } else {
                            $(this).css('background-image', 'url("../static/images/magnifying-glass.png")');
                        }
                    });
                });

                $(document).ready(function () {
                    function updateSpeciesSelection(selectedID) {
                        // Update logic as before
                        $('#species_name_id').val(selectedID);
                        $('#id_name_common').val(selectedID);
                        // Include any additional logic needed for synchronization
                    }

                    // Initialize the species selection based on the current dropdown values
                    // Assuming that at page load, both dropdowns are synchronized and either both have a value or are empty
                    var initialSelectedID = $('#id_name_latin').val() || $('#id_name_common').val();
                    updateSpeciesSelection(initialSelectedID);

                    // Event handlers for dropdown changes
                    $('#id_name_latin').change(function () {
                        updateSpeciesSelection($(this).val());
                    });

                    $('#id_name_common').change(function () {
                        updateSpeciesSelection($(this).val());
                    });
                });

                /* synchronise the species names latin/common */

                /*$(document).ready(function () {
                    function updateSpeciesSelection(selectedID) {
                        // Check if a selection has been made or if it's the 'no selection' option
                        //let valueToSet = selectedID && selectedID !== "--" ? selectedID : "";
                        //$('#species_name_id').val(valueToSet);
                        //$('#species_name_id').val('None');
                        //let valueToSet = selectedID && selectedID !== "--" ? selectedID : "";

                        // Update the hidden input. If no valid selection is made, set it to an empty string.
                        $('#species_name_id').val(selectedID);
                        $('#id_name_common').val(selectedID);
                        //$('#species_name_id').val(valueToSet);

                        // Update the Latin and common name dropdowns only if a valid selection is made.
                        /*if (selectedID && selectedID !== "--") {
                            $('#id_name_latin').val(selectedID);
                            $('#id_name_common').val(selectedID);
                        } else {
                            // Optionally, reset the dropdowns to their default 'no selection' state if needed
                            $('#id_name_latin').val('');
                            $('#id_name_common').val('');
                        }
                    }

                    // Function to update both dropdowns and the hidden input
                    /*function updateSpeciesSelection(selectedID) {
                        $('#species_name_id').val(selectedID); // Update the hidden input
                        $('#id_name_latin').val(selectedID); // Update the Latin name dropdown
                        $('#id_name_common').val(selectedID); // Update the common name dropdown
                    }

                    // When the Latin name dropdown changes...
                    $('#id_name_latin').change(function () {
                        updateSpeciesSelection($(this).val());
                    });

                    // When the common name dropdown changes...
                    $('#id_name_common').change(function () {
                        updateSpeciesSelection($(this).val());
                    });
                });*/
            </script>
        {% endblock %}


        <!-- Reference Section -->
        <section class="reference">
            <div class="entry">
                <label for="id_ref_id">Reference ID:</label>
                <input type="text" id="ref_id" name="ref_id"
                       value="{{ reference_form.ref_id.value|default_if_none:'' }}">
            </div>

            <div class="entry">
                <label for="id_author">Author:</label>
                <input type="text" id="id_author" name="author"
                       value="{{ reference_form.author.value|default_if_none:'' }}">
            </div>

            <div class="entry">
                <label for="id_reference_language">Reference Language:</label>
                {{ reference_form.language }}
            </div>

            <div class="translation">
                <label for="id_translation">English Translation Available:</label>
                <input type="checkbox" id="id_translation" name="translation"
                       value="{{ reference_form.translation.value }}">
            </div>


            <div class="pub">
                <label for="id_article_title">Article Title:</label>
                <input class="full-width article-title-search" type="text" id="id_article_title" name="article_title"
                       style="background-image: url('../static/images/magnifying-glass.png'); background-repeat: no-repeat; background-position: 10px center;"
                       value="{{ reference_form.article_title.value|default_if_none:'' }}">
            </div>
            <div class="pub">
                <label for="id_publication_title">Publication Title:</label>
                {{ reference_form.pub_title }}
            </div>


            <div class="entry">
                <label for="id_volume">Volume:</label>
                <input type="text" id="id_volume" name="volume"
                       value="{{ reference_form.volume.value|default_if_none:'' }}">
            </div>
            <div class="entry">
                <label for="id_pages">Page Numbers:</label>
                <input type="text" id="id_pages" name="pages"
                       value="{{ reference_form.pages.value|default_if_none:'' }}">
            </div>
            <div class="entry">
                <label for="id_year">Year:</label>
                <input type="text" id="id_year" name="year"
                       value="{{ reference_form.year.value|default_if_none:'' }}">
            </div>
            <div class="entry">
                <label for="id_part">Part:</label>
                <input type="text" id="id_part" name="part"
                       value="{{ reference_form.part.value|default_if_none:'' }}">
            </div>
            <div class="entry">
                <label for="id_publication_type">Publication Type:</label>
                {{ reference_form.pub_type }}
            </div>
        </section>


        <!-- Species Section -->
        <section class="species">
            <div class="entry">
                <label for="habitat_specific_type">Habitat:</label>
                {{ datacr_form.habitat | add_class:"limited" }}
            </div>
            <div class="entry">
                <label for="id_icrp_rap">ICRP RAP:</label>
                {{ datacr_form.icrp_rap | add_class:"limited" }}
            </div>
            <div class="entry">
                <label for="id_lifestage">Lifestage:</label>
                {{ datacr_form.lifestage | add_class:"limited" }}
            </div>
            <div class="left-mid">
                <div class="entry">
                    <label for="id_wildlife_group">Wildlife Group:</label>
                    {{ datacr_form.wildlife_group | add_class:"limited" }}
                </div>
                <div class="entry">
                    <label for="id_studytype">Studytype:</label>
                    {{ datacr_form.study_type | add_class:"limited" }}
                </div>
                <div class="entry">
                    <textarea id="id_notes" name="notes" placeholder="Notes"></textarea>
                </div>
            </div>
            <input type="hidden" name="species_name" id="species_name_id"
                   value="{{ datacr_form.species_name.value }}">

            <div class="entry">
                <label for="id_name_latin">Species Latin:</label>
                <select class="limited" id="id_name_latin" name="name_latin">
                    <!--<option value="">No Selection</option>-->
                    {% for species in species_list %}
                        <option value="{{ species.species_id }}">{{ species.name_latin }}</option>
                    {% endfor %}
                </select>

                {% if datacr_form.species_name.errors %}
                    <div class="alert alert-warning" role="alert" style="color: red">
                        {{ datacr_form.species_name.errors.as_text }}
                    </div>
                {% endif %}
            </div>
            <div class="entry">
                <label for="id_measurement_date">Sampling Date:</label>
                <input type="date" id="id_measurement_date" name="measurement_date">
            </div>
            <div class="entry">
                <label for="id_biohalflife">Biohalflife:</label>
                <input type="text" id="id_biohalflife" name="biohalflife">
            </div>
            <div class="entry">
                <label for="id_name_common">Species Common:</label>
                <select class="limited" id="id_name_common" name="common">
                    {% for species in species_list %}
                        <option value="{{ species.species_id }}">{{ species.name_common }}</option>
                    {% endfor %}
                </select>
                <div class="entry">
                    <label for="id_radionuclide">Element/Nuclide:</label>
                    {{ datacr_form.radionuclide | add_class:"limited" }}
                </div>
            </div>
        </section>

        <!-- Sample Section -->
        <section class="media">
            <div class="entry">
                <label for="id_media">Media Type:</label>
                {{ datacr_form.media | add_class:"limited" }}
            </div>
            <div class="entry">
                <label for="id_biota_n">N for Media:</label>
                <input type="text" id="id_biota_n" name="n_biota_n">
            </div>
            <div class="entry">
                <label for="id_media_wet_dry">Media Wet/Dry:</label>
                <select id="id_media_wet_dry" name="media_wet_dry">
                    <option value="Wet">Wet</option>
                    <option value="Dry">Dry</option>
                </select>
            </div>
            <div class="entry">
                <label for="id_media_sd">SD for Media:</label>
                <input type="text" id="id_media_sd" name="media_sd">
            </div>
            <div class="entry">
                <label for="id_media_conc">Media Concentration:</label>
                <input type="text" id="id_media_conc" name="media_conc">
            </div>
            <div class="entry">
                <label for="id_media_conc_units">Media Units:</label>
                <select id="id_media_conc_units" name="media_conc_units">
                </select>
                <!-- in-between calculations result - but saved, too -->
                <input type="hidden" id="id_stand_media_conc" name="stand_media_conc" value="">
            </div>
        </section>

        <section class="tissue">
            <div class="entry">
                <label for="id_tissue_name">Tissue Type:</label>
                {{ datacr_form.tissue | add_class:"limited" }}
            </div>
            <div class="entry">
                <label for="id_biota_n">N for Biota:</label>
                <input type="text" id="id_biota_n" name="biota_n">
            </div>
            <div class="entry">
                <label for="id_biota_wet_dry">Status of Biota:</label>
                <select id="id_biota_wet_dry" name="biota_wet_dry">
                    <option value="Wet">Wet</option>
                    <option value="Dry">Dry</option>
                    <option value="Ash">Ash</option>
                </select>
            </div>
            <div class="entry">
                <label for="id_biota_sd">SD for Biota:</label>
                <input type="text" id="id_biota_sd" name="biota_sd">
            </div>
            <div class="entry">
                <label for="id_biota_conc">Biota Concentration:</label>
                <input type="text" id="id_biota_conc" name="biota_conc">
            </div>
            <div class="entry">
                <label for="id_biota_conc_units">Biota Units:</label>
                <select id="id_biota_conc_units" name="biota_conc_units">
                    <option value="µCi/kg">Bq/l</option>
                    <option value="Bq/g">Bq/l</option>
                    <option value="Bq/kg">Bq/l</option>
                    <option value="Bq/m2">Bq/l</option>
                    <option value="mBq/g">Bq/l</option>
                    <option value="mBq/kg">Bq/l</option>
                    <option value="mg/g">mg/l</option>
                    <option value="mg/kg">mg/l</option>
                    <option value="pCi/g">Bq/l</option>
                    <option value="pCi/kg">Bq/l</option>
                    <option value="ppb">ppb</option>
                    <option value="ppm">ppm</option>
                    <option value="ug/g">ug/l</option>
                    <option value="ug/kg">ug/l</option>
                </select>

                <!-- in-between calculations result - but saved, too -->
                <input type="hidden" id="id_stand_biota_conc" name="stand_biota_conc" value="">
            </div>
        </section>

        <section class="cr">
            <div class="entry">
                <label for="id_cr">Concentration Ratio:</label>
                <input type="text" id="id_cr" name="cr">

                {% if datacr_form.cr.errors %}
                    <div class="alert alert-warning" role="alert" style="color: red">
                        {{ datacr_form.cr.errors.as_text }}
                    </div>
                {% endif %}
            </div>
            <div class="entry">
                <label for="id_crn">N of CR:</label>
                <input type="text" id="id_crn" name="crn">

                {% if datacr_form.crn.errors %}
                    <div class="alert alert-warning" role="alert" style="color: red">
                        {{ datacr_form.crn.errors.as_text }}
                    </div>
                {% endif %}
            </div>
            <div class="entry">
                <label for="id_cr_sd">SD of CR:</label>
                <input type="text" id="id_cr_sd" name="cr_sd">
            </div>
        </section>


        {% block style %}
            <script src="{% static 'js/base_form_data.js' %}"></script>
            <script src="{% static 'js/add_datacr.js' %}"></script>
        {% endblock style %}

        {% block form_buttons %}
            <!-- buttons decided by child templates -->
        {% endblock %}

        {% block explanations %}
            <!-- block for extra texts below the form -->
        {% endblock explanations %}

    </form>
{% endblock %}

